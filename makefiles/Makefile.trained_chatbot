# MSL Transformer Trained Chatbot Makefile
# Builds a chatbot that loads pre-trained BookCorpus weights

CXX = clang++
CXXFLAGS = -std=c++17 -O2 -Wall -Wextra

# Metal and Objective-C++ flags
OBJCXXFLAGS = -fobjc-arc -fmodules
FRAMEWORKS = -framework Metal -framework Foundation -framework CoreGraphics

# Source files
SOURCES = src/host/chatbot_trained.mm src/host/transformer_model.mm
OBJECTS = $(SOURCES:.mm=.o)
TARGET = msl_trained_chatbot

# Include directories
INCLUDES = -I src/host

.PHONY: all clean run check_model info

all: $(TARGET)

$(TARGET): $(OBJECTS)
	@echo "ğŸ”— Linking MSL Trained Chatbot..."
	$(CXX) $(CXXFLAGS) $(OBJCXXFLAGS) $(FRAMEWORKS) $^ -o $@
	@echo "âœ… Trained Chatbot compiled successfully!"
	@echo "ğŸ“š This chatbot loads BookCorpus-trained weights"

%.o: %.mm
	@echo "ğŸ“ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(OBJCXXFLAGS) $(INCLUDES) -c $< -o $@

clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -f $(OBJECTS) $(TARGET)

check_model:
	@echo "ğŸ” Checking for trained model..."
	@if [ -f "models/bookcorpus_trained_model.bin" ]; then \
		echo "âœ… Found trained model: models/bookcorpus_trained_model.bin"; \
		echo "ğŸ“Š Model size: $$(du -h models/bookcorpus_trained_model.bin | cut -f1)"; \
	else \
		echo "âŒ No trained model found at: models/bookcorpus_trained_model.bin"; \
		echo ""; \
		echo "ğŸ“‹ To get a trained model:"; \
		echo "   1. Train a new model: make -f Makefile.train train"; \
		echo "   2. Or use existing checkpoint if available"; \
		echo ""; \
		echo "ğŸ“ Available models:"; \
		ls -la models/ 2>/dev/null || echo "   (No models directory found)"; \
	fi

run: $(TARGET) check_model
	@echo "ğŸš€ Running BookCorpus-Trained MSL Transformer Chatbot..."
	./$(TARGET)

info:
	@echo "ğŸ“‹ Trained Chatbot Information:"
	@echo "   ğŸ“š Model: BookCorpus-trained MSL Transformer"
	@echo "   ğŸ¯ Parameters: 20M+ (configurable)"
	@echo "   ğŸ’¾ Expected model file: models/bookcorpus_trained_model.bin"
	@echo "   ğŸ§  Training data: BookCorpus literature dataset"
	@echo "   âš™ï¸  Features: Nucleus sampling, temperature control, context management"
	@echo "   ğŸ­ Response quality: Should be coherent with trained weights"
	@echo ""
	@echo "ğŸ”§ To check model status: make check_model"
	@echo "ğŸš€ To run chatbot: make run"

.SUFFIXES: .mm .o 